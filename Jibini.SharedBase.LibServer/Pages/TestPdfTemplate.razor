@page "/templates/test-pdf"
@layout TemplateLayout
@namespace Jibini.SharedBase.Server.Pages
@inject IJSRuntime js

<PageTitle>Test PDF Template</PageTitle>

@{
    using var http = new System.Net.Http.HttpClient();
    var titles = new Task<string>[5];
    var messages = new Task<string>[5];

    for (int i = 0; i < messages.Length; i++)
    {
        titles[i] = http.GetStringAsync("https://hipsum.co/api/?type=hipster-centric&sentences=1");
        messages[i] = http.GetStringAsync("https://hipsum.co/api/?type=hipster-centric&sentences=2");
    }
}

@for (int i = 0; i < NUM_CHARTS; i++)
{
    var copy = i;
    
    <div class="row mb-5" style="page-break-inside: avoid;">
        @if (i % 2 == 1)
        {
            <div class="col-4">

                @{
                    var t = titles[i % messages.Length].Result.ParseTo<List<string>>()!;
                    var m = messages[i % messages.Length].Result.ParseTo<List<string>>()!;
                }

                <p><strong>@(t[0])</strong></p>
                <p>@(m[0])</p>

            </div>
        }

        <div class="col-8">

            <div class="p-1 pe-5 border border-dark" style="border-style: dashed !important;">
                <canvas id="@guid" />
            </div>

        </div>

        @if (i % 2 == 0)
        {
            <div class="col-4">

                @{
                    var t = titles[i % messages.Length].Result.ParseTo<List<string>>()!;
                    var m = messages[i % messages.Length].Result.ParseTo<List<string>>()!;
                }

                <p><strong>@(t[0])</strong></p>
                <p>@(m[0])</p>

            </div>
        }
    </div>
}

@code {
    private const int NUM_CHARTS = 20;

    private readonly Guid guid = Guid.NewGuid();
    private IJSObjectReference? chart;

    public class InteropDataset
    {
        public string Name { get; set; } = "Dataset";
        public string Color { get; set; } = "grey";
        public List<decimal> Series { get; set; } = new();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        
        var script = await js.InvokeAsync<IJSObjectReference>("import", "./js/test-graph.js");
        if (chart is null)
        {
            chart = await script.InvokeAsync<IJSObjectReference>("TestGraph.init", guid);
        }
        if (chart is not null)
        {
            await script.InvokeVoidAsync("TestGraph.update", chart, GenerateDatasets());
        }
    }

    private static List<InteropDataset> GenerateDatasets()
    {
        var series = new List<InteropDataset>()
        {
            new()
            {
                Name = "Red",
                Color = "red"
            },
            new()
            {
                Name = "Orange",
                Color = "orange"
            },
            new()
            {
                Name = "Green",
                Color = "green"
            },
        };

        for (int i = 0; i < 3; i++)
        {
            double jog = 0.0;
            for (int x = 0; x < 150; x++)
            {
                series[i].Series.Add((decimal)(Math.Sin(((double)x / 150) * 3.14 * 2 + jog / 2) * 50
                        + Math.Cos(jog) * 30));
                jog += Random.Shared.NextDouble() - 0.5;
            }
        }
        return series;
    }
}